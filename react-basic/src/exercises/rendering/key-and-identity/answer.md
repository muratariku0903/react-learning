# 言語化演習の回答

## 1. リストレンダリングにおけるkeyの必要性

<!-- ここに回答を記述してください -->
* 効率的なレンダリングをする上で、リストの項目にkeyを設定するのが好ましい。
* Reactはレンダリング時に差分計算をし、差分が生じた箇所のみDOMを更新するのだが、その際、差分計算の手掛かりとしてリストの場合はkeyを参照する。（旧Fiberツリーと新Fiberツリーでkeyが同じものを同一コンポーネントと判定）
* keyを設定すると、Reactはリスト要素の「同一性」（前回のどの要素と今回のどの要素が同じか）を対応付けやすくなる。その対応付けに基づいて、更新（update）・追加（mount）・削除（unmount）・並び替えなど、DOMに対して行う操作が決まる。



## 2. keyにindexを使うことの問題点

<!-- ここに回答を記述してください -->
* indexはリスト要素の場所に依存する値なので、要素の先頭追加など、リスト構造に影響を与える操作が走ると、それに伴ってkeyも変わってしまうため、リスト要素の「同一性」を正しく対応付けできない可能性が出てくる。
* 例えば、以下の要素があり、
  * A（key=0）
  * B（key=1）
* 先頭にCが入るとする。
  * C（key=0）
  * A（key=1）
  * B（key=2）
* このときReactはkeyを手がかりに対応付けるため、
  * 新C（key=0）は旧A（key=0）として再利用される
  * 新A（key=1）は旧B（key=1）として再利用される
  * 新B（key=2）は対応する旧要素がないため新規にmountされる
* その結果、本来「Cだけ追加」したいのに、既存コンポーネントのstate（入力欄の値、フォーカス等）が別の行に紐づいてしまうなど、意図しない挙動（バグ）が起きうる。加えて、不要な更新が増えてパフォーマンス面でも不利になる。



## 3. 「keyが不安定」とは何か、発生する問題

<!-- ここに回答を記述してください -->
* keyが不安定とは、「同じデータ（同じ行）を表しているのに、レンダリングのたびにkeyが変わってしまう」状態である。
* 例：
  * renderのたびに `Math.random()` や `Date.now()` で生成した値をkeyにしている
  * 挿入/削除/並び替えが起きるリストで `index` をkeyにしている（位置が変わるとkeyも変わる）
* 不安定なkeyの結果、Reactが要素の同一性を正しく追跡できず、
  * 本来再利用できるコンポーネントが「別物扱い」になってmount/unmountが増える（入力値やフォーカス等のstateが失われる）
  * あるいは逆に、別データを同一視してstateが別行に紐づく（indexの典型）
  * 不要な更新が増え、パフォーマンス面でも不利になる
